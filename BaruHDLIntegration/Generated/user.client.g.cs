// <auto-generated>
//     Generated by ProtoPocoGen. Do not edit.
// </auto-generated>

#nullable enable

using System;
using System.Net.Http;
using System.Text;
using System.Text.Json;
using System.Text.Json.Serialization;
using System.Threading;
using System.Threading.Tasks;

namespace Hdlctrl.V1;

/// <summary>
/// Auto-generated client for UserService
/// </summary>
public class UserServiceClient
{
    public const string ServiceName = "hdlctrl.v1.UserService";

    protected readonly HttpClient _httpClient;
    protected readonly string _baseAddress;
    protected readonly JsonSerializerOptions _jsonOptions;

    public UserServiceClient(HttpClient httpClient, string baseAddress, JsonSerializerOptions? jsonOptions = null)
    {
        _httpClient = httpClient;
        _baseAddress = baseAddress.TrimEnd('/');
        _jsonOptions = jsonOptions ?? CreateDefaultJsonOptions();
    }

    private static JsonSerializerOptions CreateDefaultJsonOptions() => new()
    {
        PropertyNamingPolicy = JsonNamingPolicy.CamelCase,
        DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull
    };

    /// <summary>
    /// Called before sending a request. Override to add authentication headers, etc.
    /// </summary>
    protected virtual void ConfigureRequest(HttpRequestMessage request) { }

    /// <summary>
    /// Called when a request fails. Return true to retry the request.
    /// </summary>
    /// <param name="response">The failed response</param>
    /// <param name="retryCount">Current retry count (starts at 0)</param>
    /// <param name="cancellationToken">Cancellation token</param>
    /// <returns>True to retry, false to throw</returns>
    protected virtual Task<bool> OnRequestFailedAsync(
        HttpResponseMessage response,
        int retryCount,
        CancellationToken cancellationToken)
    {
        return Task.FromResult(false);
    }

    protected virtual async Task<TResponse> RequestAsync<TRequest, TResponse>(
        string rpcName,
        TRequest request,
        CancellationToken cancellationToken = default)
    {
        var retryCount = 0;
        while (true)
        {
            var json = JsonSerializer.Serialize(request, _jsonOptions);
            var httpRequest = new HttpRequestMessage(HttpMethod.Post,
                $"{_baseAddress}/{ServiceName}/{rpcName}");
            httpRequest.Content = new StringContent(json, Encoding.UTF8, "application/json");

            ConfigureRequest(httpRequest);

            var response = await _httpClient.SendAsync(httpRequest, cancellationToken);

            if (!response.IsSuccessStatusCode)
            {
                if (await OnRequestFailedAsync(response, retryCount, cancellationToken))
                {
                    retryCount++;
                    continue;
                }
            }

            response.EnsureSuccessStatusCode();

            var responseJson = await response.Content.ReadAsStringAsync(cancellationToken);
            return JsonSerializer.Deserialize<TResponse>(responseJson, _jsonOptions)!;
        }
    }

    public virtual Task<TokenSetResponse> GetTokenByPasswordAsync(
        GetTokenByPasswordRequest request,
        CancellationToken cancellationToken = default)
    {
        return RequestAsync<GetTokenByPasswordRequest, TokenSetResponse>(
            "GetTokenByPassword", request, cancellationToken);
    }

    public virtual Task<ValidateRegistrationTokenResponse> ValidateRegistrationTokenAsync(
        ValidateRegistrationTokenRequest request,
        CancellationToken cancellationToken = default)
    {
        return RequestAsync<ValidateRegistrationTokenRequest, ValidateRegistrationTokenResponse>(
            "ValidateRegistrationToken", request, cancellationToken);
    }

    public virtual Task<TokenSetResponse> RegisterWithTokenAsync(
        RegisterWithTokenRequest request,
        CancellationToken cancellationToken = default)
    {
        return RequestAsync<RegisterWithTokenRequest, TokenSetResponse>(
            "RegisterWithToken", request, cancellationToken);
    }

    public virtual Task<TokenSetResponse> RefreshTokenAsync(
        RefreshTokenRequest request,
        CancellationToken cancellationToken = default)
    {
        return RequestAsync<RefreshTokenRequest, TokenSetResponse>(
            "RefreshToken", request, cancellationToken);
    }

    public virtual Task<ChangePasswordResponse> ChangePasswordAsync(
        ChangePasswordRequest request,
        CancellationToken cancellationToken = default)
    {
        return RequestAsync<ChangePasswordRequest, ChangePasswordResponse>(
            "ChangePassword", request, cancellationToken);
    }

}

